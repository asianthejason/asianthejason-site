<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WWIII - AsiantheJason</title>

  <!-- AdSense (sidebars use standard display units) -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5384832270143450"
     crossorigin="anonymous"></script>
  <!-- Google Publisher Tag (for rewarded ad gating via Ad Manager) -->
  <script async src="https://securepubads.g.doubleclick.net/tag/js/gpt.js"></script>
  <script>
    window.googletag = window.googletag || {cmd: []};
    let rewardedSlot = null;
    googletag.cmd.push(function() {
      // Define rewarded out-of-page slot (GAM)
      // Replace /YOUR_NETWORK_CODE/YOUR_REWARDED_AD_UNIT_PATH with your slot path
      rewardedSlot = googletag.defineOutOfPageSlot('/YOUR_NETWORK_CODE/YOUR_REWARDED_AD_UNIT_PATH', googletag.enums.OutOfPageFormat.REWARDED);
      if (rewardedSlot) rewardedSlot.addService(googletag.pubads());

      // Rewarded lifecycle
      googletag.pubads().addEventListener('rewardedSlotReady', e => e.makeRewardedVisible());
      googletag.pubads().addEventListener('rewardedSlotGranted', () => window.__onReward?.('granted'));
      googletag.pubads().addEventListener('rewardedSlotClosed',  () => window.__onReward?.('closed'));

      googletag.enableServices();
    });

    function showRewardedAd() {
      return new Promise((resolve, reject) => {
        window.__onReward = (state) => {
          if (state === 'granted') resolve(true);
          else reject(new Error('closed'));
        };
        googletag.cmd.push(function() {
          if (!rewardedSlot) return reject(new Error('no-slot'));
          googletag.display(rewardedSlot);
        });
      });
    }
  </script>

  <!-- W3.CSS + fonts -->
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/5/w3.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins" />
  <style>
    /* Sidebar backdrop */
.sidebar-overlay{
  position: fixed; inset: 0; display: none;
  background: rgba(0,0,0,.4);
  z-index: 1000; /* below sidebar, above page */
}

    :root {
      --header-h: 75px;
      --rail-w: 320px;  /* wide rail for 300x600 / responsive */
      --rail-gap: 16px;
      --page-max: 1600px;
    }
    * { box-sizing: border-box; }
    body, html { margin: 0; padding: 0; height: 100%; font-family: "Poppins", sans-serif; }

    /* 3-col page */
    .page {
      min-height: 100vh;
      display: grid;
      grid-template-rows: var(--header-h) 1fr auto;
      grid-template-columns: 1fr;
    }
    header.topbar {
      position: sticky; top: 0; z-index: 10;
    }

    .mainRow {
      display: grid;
      grid-template-columns: var(--rail-w) minmax(0, 1fr) var(--rail-w);
      column-gap: var(--rail-gap);
      width: min(100%, calc(var(--page-max) + var(--rail-w)*2 + var(--rail-gap)*2));
      margin: 0 auto;
      padding: 12px;
    }
    .rail {
      position: sticky;
      top: calc(var(--header-h) + 8px);
      align-self: start;
      min-height: 600px;
    }
    .centerColumn { min-width: 0; }
    #gameContainer {
      width: 100%;
      aspect-ratio: 16/9;
      max-height: calc(100vh - var(--header-h) - 120px);
      background: #0002;
      overflow: hidden;
      border-radius: 8px;
    }

    /* Tabs spacing under game */
    .tabsWrap { margin-top: 12px; }

    /* AdSense rail slots */
    .ad-rail {
      display: block;
      width: 100%;
      min-height: 250px; /* lets responsive fill */
      background: #f4f4f4;
      border-radius: 8px;
    }

    /* Collapse rails on narrow screens */
    @media (max-width: 1280px) {
      .mainRow { grid-template-columns: 1fr; }
      .rail { display: none; }
      #gameContainer { max-height: calc(100vh - var(--header-h) - 80px); }
    }

    /* Reward gate overlay */
    #adGateOverlay {
      position: fixed; inset: 0; z-index: 9999;
      background: rgba(0,0,0,0.6);
      display: none; align-items: center; justify-content: center;
    }
    #adGatePanel {
      width: min(520px, 92vw);
      background: #222; color: #fff; border: 3px solid #fff; border-radius: 12px;
      padding: 24px; text-align: center;
    }
    #adGatePanel h3 { margin: 0 0 8px; }
    #adGateMsg { margin: 8px 0 16px; color: #c8ffc8; min-height: 1.2em; }
    .btn {
      padding: 10px 16px; border: 2px solid #fff; border-radius: 10px;
      background: #0077cc; color:#fff; font-weight: 600; cursor: pointer;
    }
    .btn:hover { background:#0090ff; }
  </style>

  <!-- Phaser -->
  <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>

  <!-- Firebase (App + Firestore compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAteayH-i26BMMYrTHecwlJF1S4DKmDPXI",
      authDomain: "wwiii-game-af0e7.firebaseapp.com",
      projectId: "wwiii-game-af0e7",
      storageBucket: "wwiii-game-af0e7.appspot.com",
      messagingSenderId: "906432978784",
      appId: "1:906432978784:web:433e23330bef1e6a3ac805"
    };
    firebase.initializeApp(firebaseConfig);
    window.db = firebase.firestore();
  </script>
</head>
<body>

  <div class="page">
    <!-- Top bar -->
    <header class="topbar w3-container w3-top w3-red w3-xlarge w3-padding">
      <a href="javascript:void(0)" class="w3-button w3-red w3-margin-right" onclick="openSidebar()">☰</a>
      <span>AsiantheJason</span>
    </header>

    <!-- Body: LEFT RAIL • GAME • RIGHT RAIL -->
    <div class="mainRow">
      <aside class="rail">
        <!-- Left responsive AdSense unit: replace data-ad-slot -->
        <ins class="adsbygoogle ad-rail"
             data-ad-client="ca-pub-5384832270143450"
             data-ad-slot="YOUR_LEFT_SIDEBAR_SLOT"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
      </aside>

      <main class="centerColumn">
        <h1>WWIII - AsiantheJason</h1>
        <div id="gameContainer"></div>

        <div class="tabsWrap">
          <div class="w3-bar w3-light-grey">
            <button class="w3-bar-item w3-button tablink w3-red" onclick="openTab(event,'Controls')" id="defaultOpen">Controls</button>
            <button class="w3-bar-item w3-button tablink" onclick="openTab(event,'Leaderboard')">Leaderboard</button>
            <button class="w3-bar-item w3-button tablink" onclick="openTab(event,'Feedback')">Feedback</button>
          </div>

          <!-- Tab panes (kept same as your file) -->
          <div id="Controls" class="tabcontent w3-container">
            <h3>Controls</h3>
            <ul>
              <li>W/A/D – Move</li>
              <li>Left click – Shoot</li>
              <li>Right click – Reload</li>
              <li>Q – Previous weapon</li>
              <li>E – Next weapon</li>
              <li>F – Open/close shop</li>
              <li>Shift – Shield</li>
            </ul>
          </div>

          <div id="Leaderboard" class="tabcontent w3-container">
            <h3>Leaderboard</h3>
            <table class="w3-table w3-striped">
              <thead>
              <tr>
                <th>Days Ago</th>
                <th>Player</th>
                <th>Enemies Killed</th>
                <th>Pistol Shots</th>
                <th>Shotgun Shots</th>
                <th>Sniper Shots</th>
                <th>MG Shots</th>
                <th>Distance (m)</th>
              </tr>
              </thead>
              <tbody id="leaderBody"><tr><td colspan="8">Loading…</td></tr></tbody>
            </table>
          </div>

          <div id="Feedback" class="tabcontent w3-container">
            <h3>Feedback</h3>
            <p>Join my Discord to share feedback: <a href="https://discord.gg/GUF7C4FS" target="_blank">https://discord.gg/GUF7C4FS</a></p>
            <!-- If you keep your feedback form & list, they’ll continue to work with your existing JS. -->
          </div>
        </div>
      </main>

      <aside class="rail">
        <!-- Right responsive AdSense unit: replace data-ad-slot -->
        <ins class="adsbygoogle ad-rail"
             data-ad-client="ca-pub-5384832270143450"
             data-ad-slot="YOUR_RIGHT_SIDEBAR_SLOT"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
      </aside>
    </div>

    <!-- Footer -->
    <footer class="w3-light-grey w3-container w3-padding-32">
      <a href="/privacy.html" class="w3-hover-opacity">Privacy Policy</a>

      <p class="w3-right">Powered by <a href="https://asianthejason.com" class="w3-hover-opacity">AsiantheJason</a></p>
    </footer>
  </div>

  <!-- Sidebar drawer (unchanged minimal) -->
  <nav id="mySidebar" class="w3-sidebar w3-red w3-top w3-large w3-padding" style="z-index:1001;width:300px;display:none;font-weight:bold;">

    <br />
    <a class="w3-button w3-display-topleft" style="width:100%;font-size:22px" onclick="closeSidebar()">Close Menu</a>
    <div class="w3-container"><h3 class="w3-padding-64"><b>AsiantheJason</b></h3></div>
    <div class="w3-bar-block">
      <a href="https://asianthejason.com" class="w3-bar-item w3-button w3-hover-white">Home</a>
      <a href="https://animatedescape.com" class="w3-bar-item w3-button w3-hover-white">Animated Escape</a>
      <a href="https://asianthejason.com/WWIII" class="w3-bar-item w3-button w3-hover-white">Play WWIII Game</a>
      <a href="https://tegritea.com" class="w3-bar-item w3-button w3-hover-white">Tegritea BBT</a>
      <a href="https://saladskateboards.com" class="w3-bar-item w3-button w3-hover-white">Salad Skateboards</a>
      <a href="https://pvtlgolf.com" class="w3-bar-item w3-button w3-hover-white">Pivotal Golf</a>
    </div>
  </nav>

  <!-- Reward Gate Overlay -->
  <div id="adGateOverlay">
    <div id="adGatePanel">
      <h3>Watch an ad to unlock <strong>3 plays</strong></h3>
      <p id="adGateMsg"></p>
      <button id="watchAdBtn" class="btn">Watch Ad</button>
    </div>
  </div>

  <!-- Your game -->
  <script src="main.js"></script>

<script>
  // ---- Tabs ----
  function openTab(evt, tabName) {
    const panes = document.getElementsByClassName('tabcontent');
    for (let i = 0; i < panes.length; i++) panes[i].style.display = 'none';

    const tabs = document.getElementsByClassName('tablink');
    for (let i = 0; i < tabs.length; i++) {
      tabs[i].className = tabs[i].className.replace(' w3-red', '');
    }

    const pane = document.getElementById(tabName);
    if (pane) pane.style.display = 'block';
    if (evt && evt.currentTarget) evt.currentTarget.className += ' w3-red';
  }

  // Select the default tab on load
  document.addEventListener('DOMContentLoaded', () => {
    const def = document.getElementById('defaultOpen');
    if (def) def.click(); else openTab(null, 'Controls');
  });

  // ---- Sidebar open/close helpers ----
  function openSidebar(){
    document.getElementById('mySidebar').style.display = 'block';
    document.getElementById('sidebarOverlay').style.display = 'block';
  }
  function closeSidebar(){
    document.getElementById('mySidebar').style.display = 'none';
    document.getElementById('sidebarOverlay').style.display = 'none';
  }
  // Close on Esc
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeSidebar(); });
  // ---- Leaderboard with safe defaults + fallback ----
  (function attachLeaderboard(){
    const DB   = (window.db || firebase.firestore());
    const body = document.getElementById('leaderBody');
    if (!body) return;

    const render = (snapshot) => {
      if (!snapshot || snapshot.empty) {
        body.innerHTML = '<tr><td colspan="8">No scores yet.</td></tr>';
        return;
      }
      const now = Date.now();
      body.innerHTML = snapshot.docs.map(doc => {
        const d  = doc.data() || {};
        const bf = d.bulletsFired || {};
        const name = d.name || 'Player';
        const enemiesKilled = d.enemiesKilled ?? 0;
        const pistol  = bf.Pistol ?? 0;
        const shotgun = bf.Shotgun ?? 0;
        const sniper  = bf.Sniper ?? 0;
        const mg      = bf['Machine Gun'] ?? 0;
        const dist    = d.distance ?? 0;

        const ts = (d.createdAt && typeof d.createdAt.toDate === 'function')
          ? d.createdAt.toDate() : new Date();
        const daysAgo = Math.floor((now - ts.getTime()) / (1000 * 60 * 60 * 24));

        return `
          <tr>
            <td>${daysAgo}</td>
            <td>${name}</td>
            <td>${enemiesKilled}</td>
            <td>${pistol}</td>
            <td>${shotgun}</td>
            <td>${sniper}</td>
            <td>${mg}</td>
            <td>${dist}</td>
          </tr>`;
      }).join('');
    };

    const showError = (err) => {
      console.error('Leaderboard error:', err);
      body.innerHTML = `<tr><td colspan="8">Error loading scores: ${err && err.message ? err.message : 'unknown error'}</td></tr>`;
    };

    let painted = false;
    try {
      DB.collection('scores').orderBy('distance','desc').limit(10)
        .onSnapshot(
          snap => { painted = true; render(snap); },
          err  => { showError(err); }
        );
    } catch (e) {
      showError(e);
    }

    // Fallback once, in case the realtime listener never paints
    setTimeout(() => {
      if (painted) return;
      DB.collection('scores').orderBy('distance','desc').limit(10)
        .get()
        .then(render)
        .catch(showError);
    }, 2000);
  })();
</script>

  <div id="sidebarOverlay" class="sidebar-overlay" onclick="closeSidebar()"></div>

</body>
</html>
